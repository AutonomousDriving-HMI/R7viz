{"version":3,"sources":["../../../src/utils/worker-utils.js"],"names":["getTransferList","object","recursive","transfers","transfersSet","Set","ArrayBuffer","add","buffer","key","undefined","Array","from","WorkerThread","url","metadata","worker","Worker","isBusy","data","Promise","resolve","reject","onmessage","e","onerror","err","postMessage","terminate","WorkerFarm","workerURL","maxConcurrency","debug","initialMessage","workers","queue","i","name","broadcast","forEach","find","count","length","getAvailableWorker","job","shift","message","backlog","process","then","onResult","catch","onError","next","push"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/* global Worker */\n\nexport function getTransferList(object, recursive = true, transfers) {\n  // Make sure that items in the transfer list is unique\n  const transfersSet = transfers || new Set();\n\n  if (!object) {\n    // ignore\n  } else if (object instanceof ArrayBuffer) {\n    transfersSet.add(object);\n  } else if (object.buffer && object.buffer instanceof ArrayBuffer) {\n    // Typed array\n    transfersSet.add(object.buffer);\n  } else if (recursive && typeof object === 'object') {\n    for (const key in object) {\n      // Avoid perf hit - only go one level deep\n      getTransferList(object[key], false, transfersSet);\n    }\n  }\n\n  // If transfers is defined, is internal recursive call\n  // Otherwise it's called by the user\n  return transfers === undefined ? Array.from(transfersSet) : null;\n}\n\n/**\n * A worker in the WorkerFarm\n */\nclass WorkerThread {\n  constructor({url, metadata}) {\n    this.worker = new Worker(url);\n    this.isBusy = false;\n    this.metadata = metadata;\n  }\n\n  process(data) {\n    const {worker} = this;\n\n    return new Promise((resolve, reject) => {\n      worker.onmessage = e => {\n        this.isBusy = false;\n        // console.log(e.data._size, `${Date.now() - e.data._sentAt}ms`);\n        resolve(e.data);\n      };\n\n      worker.onerror = err => {\n        this.isBusy = false;\n        reject(err);\n      };\n\n      this.isBusy = true;\n      worker.postMessage(data, getTransferList(data));\n    });\n  }\n\n  terminate() {\n    this.worker.terminate();\n    this.worker = null;\n  }\n}\n\n/**\n * Process multiple data messages with a fleet of workers\n */\nexport class WorkerFarm {\n  /**\n   * @param workerURL {function | string} - worker function\n   * @param maxConcurrency {number} - max count of workers\n   */\n  constructor({workerURL, maxConcurrency = 1, debug = () => {}, initialMessage = null}) {\n    this.workerURL = workerURL;\n    this.workers = [];\n    this.queue = [];\n    this.debug = debug;\n\n    for (let i = 0; i < maxConcurrency; i++) {\n      this.workers[i] = new WorkerThread({\n        url: this.workerURL,\n        metadata: {name: `${i}/${maxConcurrency}`}\n      });\n    }\n\n    if (initialMessage) {\n      this.broadcast(initialMessage);\n    }\n  }\n\n  destroy() {\n    this.workers.forEach(worker => worker.terminate());\n  }\n\n  getAvailableWorker() {\n    return this.workers.find(worker => !worker.isBusy);\n  }\n\n  broadcast(data) {\n    const count = this.workers.length;\n    // queue in reverse order as bias worker searching in getAvailableWorker()\n    for (let i = count - 1; i >= 0; i--) {\n      this.workers[i].worker.postMessage(data, getTransferList(data));\n    }\n  }\n\n  next() {\n    const {queue} = this;\n\n    while (queue.length) {\n      const worker = this.getAvailableWorker();\n      if (!worker) {\n        break;\n      }\n      const job = queue.shift();\n\n      this.debug({\n        message: 'processing',\n        worker: worker.metadata.name,\n        backlog: queue.length\n      });\n\n      worker\n        .process(job.data)\n        .then(job.onResult)\n        .catch(job.onError)\n        .then(() => this.next());\n    }\n  }\n\n  process(data, onResult, onError) {\n    this.queue.push({data, onResult, onError});\n    this.next();\n  }\n}\n"],"file":"worker-utils.js"}