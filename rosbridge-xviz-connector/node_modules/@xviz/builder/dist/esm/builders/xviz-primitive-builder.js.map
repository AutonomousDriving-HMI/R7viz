{"version":3,"sources":["../../../src/builders/xviz-primitive-builder.js"],"names":["XVIZBaseBuilder","CATEGORY","PRIMITIVE_TYPES","XVIZPrimitiveBuilder","props","category","primitive","reset","_primitives","data","_type","_flush","Uint8Array","validateError","validatePropSetOnce","image","_image","widthPixel","heightPixel","width_px","height_px","vertices","_vertices","polygon","polyline","point","position","radius","_radius","circle","start","end","length","stadium","message","_text","colorArray","_colors","style","_validatePrerequisite","_style","_validateStyle","identifier","_id","classList","_classes","isImage","validateWarn","_streamId","_validate","_flushPrimitives","Object","keys","stream","_formatPrimitive","arrayFieldName","array","undefined","push","obj","colors","points","text","center","assign","haveBase","base","object_id","classes","_validator","validateStyle"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/* eslint-disable camelcase */\nimport XVIZBaseBuilder from './xviz-base-builder';\nimport {CATEGORY, PRIMITIVE_TYPES} from './constant';\n\nexport default class XVIZPrimitiveBuilder extends XVIZBaseBuilder {\n  constructor(props) {\n    super({\n      category: CATEGORY.primitive,\n      ...props\n    });\n\n    this.reset();\n    // primitives: {[streamId]: []}\n    this._primitives = {};\n  }\n\n  image(data) {\n    if (this._type) {\n      this._flush();\n    }\n\n    if (!(data instanceof Uint8Array || typeof data === 'string')) {\n      this.validateError('An image data must be a string or Uint8Array.');\n    }\n\n    this.validatePropSetOnce('_image');\n    this._type = PRIMITIVE_TYPES.image;\n\n    this._image = {\n      data\n    };\n\n    return this;\n  }\n\n  dimensions(widthPixel = null, heightPixel = null) {\n    if (!this._image) {\n      this.validateError('An image needs to be set first.');\n    }\n\n    this._image.width_px = widthPixel;\n    this._image.height_px = heightPixel;\n\n    return this;\n  }\n\n  polygon(vertices) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_vertices');\n\n    this._vertices = vertices;\n    this._type = PRIMITIVE_TYPES.polygon;\n\n    return this;\n  }\n\n  polyline(vertices) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_vertices');\n\n    this._vertices = vertices;\n    this._type = PRIMITIVE_TYPES.polyline;\n\n    return this;\n  }\n\n  points(vertices) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_vertices');\n\n    this._vertices = vertices;\n    this._type = PRIMITIVE_TYPES.point;\n\n    return this;\n  }\n\n  circle(position, radius) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_radius');\n\n    this.position(position);\n\n    this._radius = radius;\n    this._type = PRIMITIVE_TYPES.circle;\n\n    return this;\n  }\n\n  stadium(start, end, radius) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_radius');\n\n    if (start.length !== 3) {\n      this.validateError(\n        `The start position must be of the form [x, y, z] where ${start} was provided`\n      );\n    }\n\n    if (end.length !== 3) {\n      this.validateError(\n        `The end position must be of the form [x, y, z] where ${end} was provided`\n      );\n    }\n\n    this._vertices = [start, end];\n    this._radius = radius;\n    this._type = PRIMITIVE_TYPES.stadium;\n\n    return this;\n  }\n\n  // TODO/Xintong validate `text` primitive\n  text(message) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this._text = message;\n    this._type = 'text';\n    return this;\n  }\n\n  position(point) {\n    this.validatePropSetOnce('_vertices');\n\n    if (point.length !== 3) {\n      this.validateError(`A position must be of the form [x, y, z] where ${point} was provided`);\n    }\n\n    this._vertices = [point];\n    return this;\n  }\n\n  colors(colorArray) {\n    this.validatePropSetOnce('_colors');\n\n    this._colors = colorArray;\n    return this;\n  }\n\n  style(style) {\n    this._validatePrerequisite();\n    this.validatePropSetOnce('_style');\n\n    this._style = style;\n\n    this._validateStyle();\n\n    return this;\n  }\n\n  id(identifier) {\n    this._validatePrerequisite();\n    this.validatePropSetOnce('_id');\n\n    this._id = identifier;\n    return this;\n  }\n\n  classes(classList) {\n    this._validatePrerequisite();\n    this.validatePropSetOnce('_classes');\n\n    this._classes = classList;\n    return this;\n  }\n\n  _validate() {\n    super._validate();\n\n    const isImage = this._type === PRIMITIVE_TYPES.image;\n    if (isImage && (!this._image || !this._image.data)) {\n      this.validateWarn(`Stream ${this._streamId} image data are not provided.`);\n    }\n    if (!isImage && !this._vertices) {\n      this.validateWarn(`Stream ${this._streamId} primitives vertices are not provided.`);\n    }\n  }\n\n  _flush() {\n    this._validate();\n    this._flushPrimitives();\n  }\n\n  getData() {\n    if (this._type) {\n      this._flush();\n    }\n\n    if (Object.keys(this._primitives).length === 0) {\n      return null;\n    }\n\n    return this._primitives;\n  }\n\n  _validatePrerequisite() {\n    if (!this._type) {\n      this.validateError('Start from a primitive first, e.g polygon(), image(), etc.');\n    }\n  }\n\n  _flushPrimitives() {\n    let stream = this._primitives[this._streamId];\n    if (!stream) {\n      stream = {};\n      this._primitives[this._streamId] = stream;\n    }\n\n    const primitive = this._formatPrimitive();\n\n    // Each type like \"image\" has an \"images\" array, this hack saves a\n    // big switch statement.\n    const arrayFieldName = `${this._type}s`;\n    let array = stream[arrayFieldName];\n\n    // Make sure array exists\n    if (array === undefined) {\n      array = [];\n      stream[arrayFieldName] = array;\n    }\n\n    // Now add the primitive to it\n    array.push(primitive);\n\n    this.reset();\n  }\n\n  /* eslint-disable complexity */\n  _formatPrimitive() {\n    const obj = {};\n\n    switch (this._type) {\n      case 'polygon':\n      case 'polyline':\n        obj.vertices = this._vertices;\n        break;\n      case 'point':\n        if (this._colors) {\n          obj.colors = this._colors;\n        }\n        obj.points = this._vertices;\n        break;\n      case 'text':\n        obj.position = this._vertices[0];\n        obj.text = this._text;\n        break;\n      case 'circle':\n        obj.center = this._vertices[0];\n        obj.radius = this._radius;\n        break;\n      case 'stadium':\n        obj.start = this._vertices[0];\n        obj.end = this._vertices[1];\n        obj.radius = this._radius;\n        break;\n      case 'image':\n        if (this._vertices) {\n          this._image.position = this._vertices[0];\n        }\n        Object.assign(obj, this._image);\n        break;\n      default:\n    }\n\n    let haveBase = false;\n    const base = {};\n\n    if (this._id) {\n      haveBase = true;\n      base.object_id = this._id;\n    }\n\n    if (this._style) {\n      haveBase = true;\n      base.style = this._style;\n    }\n\n    if (this._classes) {\n      haveBase = true;\n      base.classes = this._classes;\n    }\n\n    if (haveBase) {\n      obj.base = base;\n    }\n\n    return obj;\n  }\n  /* eslint-enable complexity */\n\n  _validateStyle() {\n    this._validator.validateStyle(this);\n  }\n\n  reset() {\n    this._type = null;\n\n    this._image = null;\n    this._vertices = null;\n    this._radius = null;\n    this._text = null;\n    this._colors = null;\n\n    this._id = null;\n    this._style = null;\n    this._classes = null;\n  }\n}\n"],"file":"xviz-primitive-builder.js"}