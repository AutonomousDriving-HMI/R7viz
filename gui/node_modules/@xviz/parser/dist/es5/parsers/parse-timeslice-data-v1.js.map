{"version":3,"sources":["../../../src/parsers/parse-timeslice-data-v1.js"],"names":["parseTimesliceData","data","convertPrimitive","PRIMARY_POSE_STREAM","vehiclePose","vehicle_pose","stateUpdates","state_updates","otherInfo","timestamp","time","reduce","t","stateUpdate","Math","max","type","LOG_STREAM_MESSAGE","INCOMPLETE","newStreams","result","TIMESLICE","streams","xvizStreams","parseStateUpdates","Object","assign","STREAM_BLACKLIST","primitives","variables","futures","keys","filter","streamName","has","forEach","primitive","variable","future"],"mappings":";;;;;;;AAeA;;AACA;;AACA;;;;;;;;;;AAEe,SAASA,kBAAT,CAA4BC,IAA5B,EAAkCC,gBAAlC,EAAoD;AAAA,uBACnC,gCADmC;AAAA,MAC1DC,mBAD0D,kBAC1DA,mBAD0D;;AAAA,MAE5CC,WAF4C,GAEcH,IAFd,CAE1DI,YAF0D;AAAA,MAEhBC,YAFgB,GAEcL,IAFd,CAE/BM,aAF+B;AAAA,MAECC,SAFD,4BAEcP,IAFd;;AAIjE,MAAIQ,SAAJ;;AACA,MAAIL,WAAJ,EAAiB;AACfK,IAAAA,SAAS,GAAGL,WAAW,CAACM,IAAxB;AACD,GAFD,MAEO,IAAIJ,YAAJ,EAAkB;AACvBG,IAAAA,SAAS,GAAGH,YAAY,CAACK,MAAb,CAAoB,UAACC,CAAD,EAAIC,WAAJ,EAAoB;AAClD,aAAOC,IAAI,CAACC,GAAL,CAASH,CAAT,EAAYC,WAAW,CAACJ,SAAxB,CAAP;AACD,KAFW,EAET,CAFS,CAAZ;AAGD;;AAED,MAAI,CAACA,SAAL,EAAgB;AACd;AACA,WAAO;AAACO,MAAAA,IAAI,EAAEC,8BAAmBC;AAA1B,KAAP;AACD;;AAED,MAAMC,UAAU,GAAG,EAAnB;;AACA,MAAMC,MAAM,qBACPZ,SADO;AAEVQ,IAAAA,IAAI,EAAEC,8BAAmBI,SAFf;AAGVC,IAAAA,OAAO,EAAEH,UAHC;AAIVV,IAAAA,SAAS,EAATA;AAJU,IAAZ;;AAOA,MAAIH,YAAJ,EAAkB;AAChB,QAAMiB,WAAW,GAAGC,iBAAiB,CAAClB,YAAD,EAAeG,SAAf,EAA0BP,gBAA1B,CAArC;AACAuB,IAAAA,MAAM,CAACC,MAAP,CAAcP,UAAd,EAA0BI,WAA1B;AACD;;AAED,MAAInB,WAAJ,EAAiB;AACf;AACAe,IAAAA,UAAU,CAAChB,mBAAD,CAAV,GAAkCC,WAAlC;AACD;;AAED,SAAOgB,MAAP;AACD;;AAED,SAASI,iBAAT,CAA2BlB,YAA3B,EAAyCG,SAAzC,EAAoDP,gBAApD,EAAsE;AAAA,wBACzC,gCADyC;AAAA,MAC7DyB,gBAD6D,mBAC7DA,gBAD6D;;AAGpE,MAAMR,UAAU,GAAG,EAAnB;AACA,MAAMS,UAAU,GAAG,EAAnB;AACA,MAAMC,SAAS,GAAG,EAAlB;AACA,MAAMC,OAAO,GAAG,EAAhB;AANoE;AAAA;AAAA;;AAAA;AAQpE,yBAA0BxB,YAA1B,8HAAwC;AAAA,UAA7BO,WAA6B;AACtCY,MAAAA,MAAM,CAACC,MAAP,CAAcE,UAAd,EAA0Bf,WAAW,CAACe,UAAtC;AACAH,MAAAA,MAAM,CAACC,MAAP,CAAcG,SAAd,EAAyBhB,WAAW,CAACgB,SAArC;AACAJ,MAAAA,MAAM,CAACC,MAAP,CAAcI,OAAd,EAAuBjB,WAAW,CAACiB,OAAnC;AACD;AAZmE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAcpEL,EAAAA,MAAM,CAACM,IAAP,CAAYH,UAAZ,EACGI,MADH,CACU,UAAAC,UAAU;AAAA,WAAI,CAACN,gBAAgB,CAACO,GAAjB,CAAqBD,UAArB,CAAL;AAAA,GADpB,EAEGE,OAFH,CAEW,UAAAC,SAAS,EAAI;AACpBjB,IAAAA,UAAU,CAACiB,SAAD,CAAV,GAAwB,2CACtBR,UAAU,CAACQ,SAAD,CADY,EAEtBA,SAFsB,EAGtB3B,SAHsB,EAItBP,gBAJsB,CAAxB;AAMD,GATH;AAWAuB,EAAAA,MAAM,CAACM,IAAP,CAAYF,SAAZ,EACGG,MADH,CACU,UAAAC,UAAU;AAAA,WAAI,CAACN,gBAAgB,CAACO,GAAjB,CAAqBD,UAArB,CAAL;AAAA,GADpB,EAEGE,OAFH,CAEW,UAAAE,QAAQ,EAAI;AACnBlB,IAAAA,UAAU,CAACkB,QAAD,CAAV,GAAuB,0CAAoBR,SAAS,CAACQ,QAAD,CAA7B,EAAyCA,QAAzC,EAAmD5B,SAAnD,CAAvB;AACD,GAJH;AAMAgB,EAAAA,MAAM,CAACM,IAAP,CAAYD,OAAZ,EACGE,MADH,CACU,UAAAC,UAAU;AAAA,WAAI,CAACN,gBAAgB,CAACO,GAAjB,CAAqBD,UAArB,CAAL;AAAA,GADpB,EAEGE,OAFH,CAEW,UAAAG,MAAM,EAAI;AACjBnB,IAAAA,UAAU,CAACmB,MAAD,CAAV,GAAqB,yCAAmBR,OAAO,CAACQ,MAAD,CAA1B,EAAoCA,MAApC,EAA4C7B,SAA5C,EAAuDP,gBAAvD,CAArB;AACD,GAJH;AAMA,SAAOiB,UAAP;AACD","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Extracts a TIMESLICE message v1\nimport {getXVIZConfig} from '../config/xviz-config';\nimport {LOG_STREAM_MESSAGE} from '../constants';\nimport {parseStreamFutures, parseStreamPrimitive, parseStreamVariable} from './parse-xviz-stream';\n\nexport default function parseTimesliceData(data, convertPrimitive) {\n  const {PRIMARY_POSE_STREAM} = getXVIZConfig();\n  const {vehicle_pose: vehiclePose, state_updates: stateUpdates, ...otherInfo} = data;\n\n  let timestamp;\n  if (vehiclePose) {\n    timestamp = vehiclePose.time;\n  } else if (stateUpdates) {\n    timestamp = stateUpdates.reduce((t, stateUpdate) => {\n      return Math.max(t, stateUpdate.timestamp);\n    }, 0);\n  }\n\n  if (!timestamp) {\n    // Incomplete stream message, just tag it accordingly so client can ignore it\n    return {type: LOG_STREAM_MESSAGE.INCOMPLETE};\n  }\n\n  const newStreams = {};\n  const result = {\n    ...otherInfo,\n    type: LOG_STREAM_MESSAGE.TIMESLICE,\n    streams: newStreams,\n    timestamp\n  };\n\n  if (stateUpdates) {\n    const xvizStreams = parseStateUpdates(stateUpdates, timestamp, convertPrimitive);\n    Object.assign(newStreams, xvizStreams);\n  }\n\n  if (vehiclePose) {\n    // v1 -> v2\n    newStreams[PRIMARY_POSE_STREAM] = vehiclePose;\n  }\n\n  return result;\n}\n\nfunction parseStateUpdates(stateUpdates, timestamp, convertPrimitive) {\n  const {STREAM_BLACKLIST} = getXVIZConfig();\n\n  const newStreams = {};\n  const primitives = {};\n  const variables = {};\n  const futures = {};\n\n  for (const stateUpdate of stateUpdates) {\n    Object.assign(primitives, stateUpdate.primitives);\n    Object.assign(variables, stateUpdate.variables);\n    Object.assign(futures, stateUpdate.futures);\n  }\n\n  Object.keys(primitives)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(primitive => {\n      newStreams[primitive] = parseStreamPrimitive(\n        primitives[primitive],\n        primitive,\n        timestamp,\n        convertPrimitive\n      );\n    });\n\n  Object.keys(variables)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(variable => {\n      newStreams[variable] = parseStreamVariable(variables[variable], variable, timestamp);\n    });\n\n  Object.keys(futures)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(future => {\n      newStreams[future] = parseStreamFutures(futures[future], future, timestamp, convertPrimitive);\n    });\n\n  return newStreams;\n}\n"],"file":"parse-timeslice-data-v1.js"}