{"version":3,"sources":["../../../../src/components/declarative-ui/image-sequence.js"],"names":["ImageSequence","props","ref","_canvas","_context","getContext","width","height","setState","brightness","contrast","saturate","invert","filter","Number","isFinite","state","_getVideoFilterCSS","currentFrameImage","clearRect","drawImage","_buffer","ImageBuffer","_getCurrentFrames","_renderFrame","nextProps","prevProps","prevState","currentTime","src","currentFrame","set","currentFrameData","get","image","promise","then","style","position","background","lineHeight","_onCanvasResize","_onCanvasLoad","PureComponent","PropTypes","oneOfType","number","string","array","isRequired"],"mappings":";;;;;;;AAqBA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA;IACqBA,a;;;;;AA2BnB,yBAAYC,KAAZ,EAAmB;AAAA;;AAAA;;AACjB,uFAAMA,KAAN;;AADiB,4FAmCH,UAAAC,GAAG,EAAI;AACrB,YAAKC,OAAL,GAAeD,GAAf;;AAEA,UAAIA,GAAJ,EAAS;AACP,cAAKE,QAAL,GAAgBF,GAAG,CAACG,UAAJ,CAAe,IAAf,CAAhB;AACD;AACF,KAzCkB;;AAAA,8FA2CD,gBAAqB;AAAA,UAAnBC,KAAmB,QAAnBA,KAAmB;AAAA,UAAZC,MAAY,QAAZA,MAAY;;AACrC,YAAKC,QAAL,CAAc;AAACF,QAAAA,KAAK,EAALA,KAAD;AAAQC,QAAAA,MAAM,EAANA;AAAR,OAAd;AACD,KA7CkB;;AAAA,iGAmEE,YAAM;AAAA,wBACwB,MAAKN,KAD7B;AAAA,UAClBQ,UADkB,eAClBA,UADkB;AAAA,UACNC,QADM,eACNA,QADM;AAAA,UACIC,QADJ,eACIA,QADJ;AAAA,UACcC,MADd,eACcA,MADd;AAEzB,UAAMC,MAAM,mBACRC,MAAM,CAACC,QAAP,CAAgBN,UAAhB,yBAA4CA,UAA5C,UAA6D,EADrD,mBAERK,MAAM,CAACC,QAAP,CAAgBJ,QAAhB,uBAAwCA,QAAxC,UAAuD,EAF/C,mBAGRG,MAAM,CAACC,QAAP,CAAgBL,QAAhB,uBAAwCA,QAAxC,UAAuD,EAH/C,mBAIRI,MAAM,CAACC,QAAP,CAAgBH,MAAhB,qBAAoCA,MAApC,UAAiD,EAJzC,CAAZ;AAKA,aAAOC,MAAP;AACD,KA3EkB;;AAAA,2FA6EJ,YAAM;AACnB,UAAI,CAAC,MAAKT,QAAV,EAAoB;AAClB;AACD;;AAED,UAAME,KAAK,GAAG,MAAKU,KAAL,CAAWV,KAAzB;AACA,UAAIC,MAAM,GAAG,MAAKS,KAAL,CAAWT,MAAxB;;AAEA,UAAI,CAACD,KAAL,EAAY;AACV;AACD;;AAED,YAAKF,QAAL,CAAcS,MAAd,GAAuB,MAAKI,kBAAL,EAAvB;AAZmB,UAcZC,iBAdY,GAcS,MAAKF,KAdd,CAcZE,iBAdY;;AAenB,UAAI,CAACA,iBAAL,EAAwB;AACtB,cAAKd,QAAL,CAAce,SAAd,CAAwB,CAAxB,EAA2B,CAA3B,EAA8Bb,KAA9B,EAAqCC,MAArC;AACD,OAFD,MAEO;AACL,YAAI,MAAKN,KAAL,CAAWM,MAAX,KAAsB,MAA1B,EAAkC;AAChCA,UAAAA,MAAM,GAAID,KAAK,GAAGY,iBAAiB,CAACZ,KAA3B,GAAoCY,iBAAiB,CAACX,MAA/D;AACD;;AACD,cAAKJ,OAAL,CAAaG,KAAb,GAAqBA,KAArB;AACA,cAAKH,OAAL,CAAaI,MAAb,GAAsBA,MAAtB;;AACA,cAAKH,QAAL,CAAcgB,SAAd,CAAwBF,iBAAxB,EAA2C,CAA3C,EAA8C,CAA9C,EAAiDZ,KAAjD,EAAwDC,MAAxD;AACD;AACF,KAtGkB;;AAGjB,UAAKc,OAAL,GAAe,IAAIC,oBAAJ,CAAgB,EAAhB,CAAf;AAEA,UAAKN,KAAL;AACEV,MAAAA,KAAK,EAAE,CADT;AAEEC,MAAAA,MAAM,EAAE;AAFV,OAGK,MAAKgB,iBAAL,CAAuBtB,KAAvB,CAHL;AAMA,UAAKE,OAAL,GAAe,IAAf;AACA,UAAKC,QAAL,GAAgB,IAAhB;AAZiB;AAalB;;;;wCAEmB;AAClB,WAAKoB,YAAL;AACD;;;8CAEyBC,S,EAAW;AACnC,WAAKjB,QAAL,mBACK,KAAKe,iBAAL,CAAuBE,SAAvB,CADL;AAGD;;;uCAEkBC,S,EAAWC,S,EAAW;AACvC,UACE,KAAKX,KAAL,CAAWE,iBAAX,KAAiCS,SAAS,CAACT,iBAA3C,IACA,KAAKF,KAAL,CAAWV,KAAX,KAAqBqB,SAAS,CAACrB,KAD/B,IAEA,KAAKU,KAAL,CAAWT,MAAX,KAAsBoB,SAAS,CAACpB,MAHlC,EAIE;AACA,aAAKiB,YAAL;AACD;AACF;;;sCAciBvB,K,EAAO;AAAA;;AAAA,UAChB2B,WADgB,GACI3B,KADJ,CAChB2B,WADgB;AAAA,UACHC,GADG,GACI5B,KADJ,CACH4B,GADG;;AAGvB,UAAMC,YAAY,GAAG,KAAKT,OAAL,CAAaU,GAAb,CAAiBF,GAAjB,EAAsBD,WAAtB,CAArB;;AACA,UAAMI,gBAAgB,GAAG,KAAKX,OAAL,CAAaY,GAAb,CAAiBH,YAAjB,CAAzB;;AAEA,UAAIE,gBAAgB,IAAI,CAACA,gBAAgB,CAACE,KAA1C,EAAiD;AAC/CF,QAAAA,gBAAgB,CAACG,OAAjB,CAAyBC,IAAzB,CAA8B,UAAAF,KAAK,EAAI;AACrC,cAAI,MAAI,CAAClB,KAAL,CAAWc,YAAX,KAA4BA,YAAhC,EAA8C;AAC5C,YAAA,MAAI,CAACtB,QAAL,CAAc;AAACU,cAAAA,iBAAiB,EAAEgB;AAApB,aAAd;AACD;AACF,SAJD;AAKD;;AAED,aAAO;AACLhB,QAAAA,iBAAiB,EAAEc,gBAAgB,IAAIA,gBAAgB,CAACE,KADnD;AAELJ,QAAAA,YAAY,EAAZA;AAFK,OAAP;AAID;;;6BAuCQ;AAAA,yBACiB,KAAK7B,KADtB;AAAA,UACAK,KADA,gBACAA,KADA;AAAA,UACOC,MADP,gBACOA,MADP;AAEP,UAAM8B,KAAK,GAAG;AACZC,QAAAA,QAAQ,EAAE,UADE;AAEZC,QAAAA,UAAU,EAAE,MAFA;AAGZC,QAAAA,UAAU,EAAE,CAHA;AAIZlC,QAAAA,KAAK,EAALA,KAJY;AAKZC,QAAAA,MAAM,EAANA;AALY,OAAd;AAQA,aACE;AAAK,QAAA,KAAK,EAAE8B;AAAZ,SACE,6BAAC,qBAAD;AAAW,QAAA,QAAQ,EAAE,KAAKI;AAA1B,QADF,EAEE;AAAQ,QAAA,GAAG,EAAE,KAAKC;AAAlB,QAFF,CADF;AAMD;;;;EAnJwCC,oB;;;;gBAAtB3C,a,eACA;AACjBM,EAAAA,KAAK,EAAEsC,mBAAUC,SAAV,CAAoB,CAACD,mBAAUE,MAAX,EAAmBF,mBAAUG,MAA7B,CAApB,CADU;AAEjBxC,EAAAA,MAAM,EAAEqC,mBAAUC,SAAV,CAAoB,CAACD,mBAAUE,MAAX,EAAmBF,mBAAUG,MAA7B,CAApB,CAFS;AAIjB;AACAlB,EAAAA,GAAG,EAAEe,mBAAUI,KALE;AAKK;AAEtB;AACAvC,EAAAA,UAAU,EAAEmC,mBAAUE,MARL;AASjBpC,EAAAA,QAAQ,EAAEkC,mBAAUE,MATH;AAUjBnC,EAAAA,QAAQ,EAAEiC,mBAAUE,MAVH;AAWjBlC,EAAAA,MAAM,EAAEgC,mBAAUE,MAXD;AAajBlB,EAAAA,WAAW,EAAEgB,mBAAUE,MAAV,CAAiBG;AAbb,C;;gBADAjD,a,kBAiBG;AACpBM,EAAAA,KAAK,EAAE,MADa;AAEpBC,EAAAA,MAAM,EAAE,MAFY;AAGpB;AACA;AACA;AACA;AACAsB,EAAAA,GAAG,EAAE;AAPe,C","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n// @flow\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\nimport {AutoSizer} from '@streetscape.gl/monochrome';\nimport ImageBuffer from '../../utils/image-buffer';\n\n/* Component that renders image sequence as video */\nexport default class ImageSequence extends PureComponent {\n  static propTypes = {\n    width: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n    height: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n\n    // Array of frames to render, in shape of {timestamp, imageUrl}\n    src: PropTypes.array, // eslint-disable-line\n\n    // Filters\n    brightness: PropTypes.number,\n    contrast: PropTypes.number,\n    saturate: PropTypes.number,\n    invert: PropTypes.number,\n\n    currentTime: PropTypes.number.isRequired\n  };\n\n  static defaultProps = {\n    width: '100%',\n    height: 'auto',\n    // brightness: 1.0,\n    // contrast: 1.0,\n    // saturate: 1.0,\n    // invert: 0.0,\n    src: []\n  };\n\n  constructor(props) {\n    super(props);\n\n    this._buffer = new ImageBuffer(10);\n\n    this.state = {\n      width: 0,\n      height: 0,\n      ...this._getCurrentFrames(props)\n    };\n\n    this._canvas = null;\n    this._context = null;\n  }\n\n  componentDidMount() {\n    this._renderFrame();\n  }\n\n  componentWillReceiveProps(nextProps) {\n    this.setState({\n      ...this._getCurrentFrames(nextProps)\n    });\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if (\n      this.state.currentFrameImage !== prevState.currentFrameImage ||\n      this.state.width !== prevState.width ||\n      this.state.height !== prevState.height\n    ) {\n      this._renderFrame();\n    }\n  }\n\n  _onCanvasLoad = ref => {\n    this._canvas = ref;\n\n    if (ref) {\n      this._context = ref.getContext('2d');\n    }\n  };\n\n  _onCanvasResize = ({width, height}) => {\n    this.setState({width, height});\n  };\n\n  _getCurrentFrames(props) {\n    const {currentTime, src} = props;\n\n    const currentFrame = this._buffer.set(src, currentTime);\n    const currentFrameData = this._buffer.get(currentFrame);\n\n    if (currentFrameData && !currentFrameData.image) {\n      currentFrameData.promise.then(image => {\n        if (this.state.currentFrame === currentFrame) {\n          this.setState({currentFrameImage: image});\n        }\n      });\n    }\n\n    return {\n      currentFrameImage: currentFrameData && currentFrameData.image,\n      currentFrame\n    };\n  }\n\n  _getVideoFilterCSS = () => {\n    const {brightness, contrast, saturate, invert} = this.props;\n    const filter = `\\\n      ${Number.isFinite(brightness) ? `brightness(${brightness}) ` : ''}\\\n      ${Number.isFinite(saturate) ? `saturate(${saturate}) ` : ''}\\\n      ${Number.isFinite(contrast) ? `contrast(${contrast}) ` : ''}\\\n      ${Number.isFinite(invert) ? `invert(${invert}) ` : ''}`;\n    return filter;\n  };\n\n  _renderFrame = () => {\n    if (!this._context) {\n      return;\n    }\n\n    const width = this.state.width;\n    let height = this.state.height;\n\n    if (!width) {\n      return;\n    }\n\n    this._context.filter = this._getVideoFilterCSS();\n\n    const {currentFrameImage} = this.state;\n    if (!currentFrameImage) {\n      this._context.clearRect(0, 0, width, height);\n    } else {\n      if (this.props.height === 'auto') {\n        height = (width / currentFrameImage.width) * currentFrameImage.height;\n      }\n      this._canvas.width = width;\n      this._canvas.height = height;\n      this._context.drawImage(currentFrameImage, 0, 0, width, height);\n    }\n  };\n\n  render() {\n    const {width, height} = this.props;\n    const style = {\n      position: 'relative',\n      background: '#000',\n      lineHeight: 0,\n      width,\n      height\n    };\n\n    return (\n      <div style={style}>\n        <AutoSizer onResize={this._onCanvasResize} />\n        <canvas ref={this._onCanvasLoad} />\n      </div>\n    );\n  }\n}\n"],"file":"image-sequence.js"}