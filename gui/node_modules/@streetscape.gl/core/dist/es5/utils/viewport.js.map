{"version":3,"sources":["../../../src/utils/viewport.js"],"names":["getViewStateOffset","oldViewState","viewState","oldOffset","oldViewport","WebMercatorViewport","oldPos","width","x","height","y","trackedLngLat","unproject","newViewport","newPos","project","bearing","offsetViewState","offset","shiftedViewState","helperViewport","pos","lngLat","longitude","latitude","getLocationAtPoint","getViews","viewMode","name","orthographic","firstPerson","mapInteraction","controllerProps","keyboard","FirstPersonView","id","fovy","near","far","focalDistance","controller","MapView","getViewStates","trackedPosition","tracked","viewStates","position","heading"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport WebMercatorViewport from 'viewport-mercator-project';\nimport {MapView, FirstPersonView} from 'deck.gl';\n\nexport function getViewStateOffset(oldViewState, viewState, oldOffset) {\n  if (!oldViewState) {\n    return oldOffset;\n  }\n\n  const oldViewport = new WebMercatorViewport(oldViewState);\n  const oldPos = [oldViewport.width / 2 + oldOffset.x, oldViewport.height / 2 + oldOffset.y];\n  const trackedLngLat = oldViewport.unproject(oldPos);\n\n  const newViewport = new WebMercatorViewport(viewState);\n  const newPos = newViewport.project(trackedLngLat);\n\n  return {\n    x: oldOffset.x + newPos[0] - oldPos[0],\n    y: oldOffset.y + newPos[1] - oldPos[1],\n    bearing: oldOffset.bearing + viewState.bearing - oldViewState.bearing\n  };\n}\n\n// Adjust lng/lat to position the car 1/4 from screen bottom\nfunction offsetViewState(viewState, offset) {\n  const shiftedViewState = {\n    ...viewState,\n    bearing: viewState.bearing + offset.bearing\n  };\n\n  const helperViewport = new WebMercatorViewport(shiftedViewState);\n\n  const pos = [viewState.width / 2 + offset.x, viewState.height / 2 + offset.y];\n  const lngLat = [viewState.longitude, viewState.latitude];\n\n  const [longitude, latitude] = helperViewport.getLocationAtPoint({\n    lngLat,\n    pos\n  });\n\n  return {\n    ...shiftedViewState,\n    longitude,\n    latitude\n  };\n}\n\nexport function getViews(viewMode) {\n  const {name, orthographic, firstPerson, mapInteraction} = viewMode;\n\n  const controllerProps = {...mapInteraction, keyboard: false};\n\n  if (firstPerson) {\n    return new FirstPersonView({\n      id: name,\n      fovy: 75,\n      near: 1,\n      far: 10000,\n      focalDistance: 6,\n      controller: controllerProps\n    });\n  }\n\n  return new MapView({\n    id: name,\n    orthographic,\n    controller: controllerProps\n  });\n}\n\n// Creates viewports that contains information about car position and heading\nexport function getViewStates({viewState, trackedPosition, viewMode, offset}) {\n  const {name, firstPerson, tracked = {}} = viewMode;\n\n  const viewStates = {};\n\n  if (firstPerson) {\n    if (trackedPosition) {\n      const bearing = trackedPosition.bearing;\n      viewState = {\n        ...viewState,\n        ...firstPerson,\n        longitude: trackedPosition.longitude,\n        latitude: trackedPosition.latitude,\n        bearing: bearing + offset.bearing\n      };\n    }\n    viewStates[name] = viewState;\n  } else {\n    viewState = {...viewState};\n    offset = {...offset};\n\n    // Track car position & heading\n    if (tracked.position && trackedPosition) {\n      viewState.longitude = trackedPosition.longitude;\n      viewState.latitude = trackedPosition.latitude;\n    } else {\n      offset.x = 0;\n      offset.y = 0;\n    }\n    if (tracked.heading && trackedPosition) {\n      viewState.bearing = trackedPosition.bearing;\n    } else {\n      offset.bearing = 0;\n    }\n\n    viewStates[name] = offsetViewState(viewState, offset);\n  }\n\n  return viewStates;\n}\n/* eslint-enable max-params */\n"],"file":"viewport.js"}