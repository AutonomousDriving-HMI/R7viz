{"version":3,"sources":["../../../src/loaders/xviz-live-loader.js"],"names":["assert","XVIZStreamBuffer","XVIZWebsocketLoader","DEFAULT_LOG_PROFILE","DEFAULT_RETRY_ATTEMPTS","getSocketRequestParams","options","logProfile","serverConfig","bufferLength","queryParams","profile","retryAttempts","Number","isInteger","qs","Object","keys","map","key","join","url","serverUrl","XVIZLiveLoader","constructor","message","bufferUpdated","seek","timestamp","requestParams","retrySettings","retries","minTimeout","randomize","bufferChunk","streamBuffer","startOffset","endOffset","getBufferRange","bufferRange","start","end","getBufferStart","getBufferEnd","setCurrentTime"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* eslint-disable camelcase */\nimport assert from 'assert';\nimport {XVIZStreamBuffer} from '@xviz/parser';\n\nimport XVIZWebsocketLoader from './xviz-websocket-loader';\n\nconst DEFAULT_LOG_PROFILE = 'default';\nconst DEFAULT_RETRY_ATTEMPTS = 3;\n\nfunction getSocketRequestParams(options) {\n  const {logProfile = DEFAULT_LOG_PROFILE, serverConfig, bufferLength = 30} = options;\n\n  const queryParams = {\n    ...serverConfig.queryParams,\n    profile: logProfile\n  };\n  const retryAttempts = Number.isInteger(serverConfig.retryAttempts)\n    ? serverConfig.retryAttempts\n    : DEFAULT_RETRY_ATTEMPTS;\n\n  const qs = Object.keys(queryParams)\n    .map(key => `${key}=${queryParams[key]}`)\n    .join('&');\n\n  return {\n    url: `${serverConfig.serverUrl}?${qs}`,\n    logProfile,\n    bufferLength,\n    retryAttempts,\n    serverConfig\n  };\n}\n\n/*\n * Handle connecting to XVIZ socket and negotiation of the XVIZ protocol version\n *\n * This loader is used when connecting to a \"live\" XVIZ websocket.\n * This implies that the metadata does not have a start or end time\n * and that we want to display the latest message as soon as it arrives.\n */\nexport default class XVIZLiveLoader extends XVIZWebsocketLoader {\n  /**\n   * constructor\n   * @params serverConfig {object}\n   *   - serverConfig.serverUrl {string}\n   *   - serverConfig.defaultLogLength {number, optional} - default 30\n   *   - serverConfig.queryParams {object, optional}\n   *   - serverConfig.retryAttempts {number, optional} - default 3\n   * @params worker {string|function, optional}\n   * @params maxConcurrency {number, optional} - default 3\n   * @params logProfile {string, optional}\n   * @params bufferLength {number, optional}\n   */\n  constructor(options = {}) {\n    super(options);\n\n    // Construct websocket connection details from parameters\n    this.requestParams = getSocketRequestParams(options);\n    assert(this.requestParams.bufferLength, 'bufferLength must be provided');\n\n    this.retrySettings = {\n      retries: this.requestParams.retryAttempts,\n      minTimeout: 500,\n      randomize: true\n    };\n\n    // Setup relative stream buffer storage by splitting bufferLength 1/3 : 2/3\n    const bufferChunk = this.requestParams.bufferLength / 3;\n\n    // Replace base class object\n    this.streamBuffer = new XVIZStreamBuffer({\n      startOffset: -2 * bufferChunk,\n      endOffset: bufferChunk\n    });\n  }\n\n  getBufferRange() {\n    const bufferRange = this.streamBuffer.getBufferRange();\n    return [[bufferRange.start, bufferRange.end]];\n  }\n\n  getBufferStart() {\n    return this.streamBuffer && this.streamBuffer.getBufferRange().start;\n  }\n\n  getBufferEnd() {\n    return this.streamBuffer && this.streamBuffer.getBufferRange().end;\n  }\n\n  seek(timestamp) {\n    super.seek(timestamp);\n\n    // Info the streamBuffer so it can prune appropriately\n    this.streamBuffer.setCurrentTime(timestamp);\n  }\n\n  _onOpen = () => {};\n\n  _onXVIZTimeslice = (message, bufferUpdated) => {\n    // Live loader always shows latest data\n    this.seek(message.timestamp);\n  };\n}\n"],"file":"xviz-live-loader.js"}