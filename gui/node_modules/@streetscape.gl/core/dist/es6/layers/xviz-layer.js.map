{"version":3,"sources":["../../../src/layers/xviz-layer.js"],"names":["CompositeLayer","ScatterplotLayer","PathLayer","PolygonLayer","TextLayer","PointCloudLayer","XVIZObject","deepExtend","XVIZ_TO_LAYER_TYPE","points2d","points3d","point2d","circle2d","line2d","path2d","polygon2d","point","circle","polyline","polygon","text","stadium","STYLE_TO_LAYER_PROP","scatterplot","opacity","radius_min_pixels","radius_max_pixels","radius","stroked","filled","stroke_width_min_pixels","stroke_width_max_pixels","stroke_width","stroke_color","fill_color","pointcloud","radius_pixels","point_color_mode","point_color_domain","path","extruded","height","font_family","font_weight","text_size","text_rotation","text_anchor","text_baseline","EMPTY_OBJECT","getInlineProperty","context","propertyName","objectState","inlineProp","undefined","getStylesheetProperty","style","getProperty","f","useSemanticColor","get","id","altPropertyName","property","disableInlineStyling","getPropertyDefault","XVIZLayer","_getProperty","props","_getPropertyAccessor","_getDefaultLayerProps","styleToLayerProp","layerProps","updateTriggers","stylePropName","layerPropName","isAccessor","startsWith","dependencies","getPropertyDependencies","_getLayerProps","objectStates","state","key","trigger","forEach","stateName","_getLayerType","data","length","type","updateState","oldProps","changeFlags","dataChanged","dataType","vertices","Array","isArray","reduce","arr","multiPoints","pt","push","setState","renderLayers","lightSettings","linkTitle","streamName","objectType","forwardProps","getSubLayerProps","getPosition","center","getFillColor","ids","numInstances","instancePositions","positions","instanceColors","colors","vehicleRelativeTransform","p","getPath","getColor","start","end","lineJointRounded","wireframe","getPolygon","getLineColor","getText","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* eslint-disable camelcase */\nimport {CompositeLayer} from '@deck.gl/core';\nimport {ScatterplotLayer, PathLayer, PolygonLayer, TextLayer} from '@deck.gl/layers';\nimport PointCloudLayer from './point-cloud-layer/point-cloud-layer';\n// TODO/ib - Uncomment to enable binary/flat polygon arrays\n// import PathLayer from './binary-path-layer/binary-path-layer';\n// import PolygonLayer from './binary-polygon-layer/binary-polygon-layer';\n\nimport {XVIZObject} from '@xviz/parser';\n\nimport deepExtend from 'lodash.merge';\n\nconst XVIZ_TO_LAYER_TYPE = {\n  // V1\n  points2d: 'scatterplot',\n  points3d: 'pointcloud',\n  point2d: 'scatterplot',\n  circle2d: 'scatterplot',\n  line2d: 'path',\n  path2d: 'path',\n  polygon2d: 'polygon',\n\n  // V2\n  point: 'pointcloud',\n  circle: 'scatterplot',\n  polyline: 'path',\n  polygon: 'polygon',\n  text: 'text',\n  stadium: 'stadium'\n};\n\nconst STYLE_TO_LAYER_PROP = {\n  scatterplot: {\n    opacity: 'opacity',\n    radius_min_pixels: 'radiusMinPixels',\n    radius_max_pixels: 'radiusMaxPixels',\n    radius: 'getRadius',\n    stroked: 'stroked',\n    filled: 'filled',\n    stroke_width_min_pixels: 'widthMinPixels',\n    stroke_width_max_pixels: 'widthMaxPixels',\n    stroke_width: 'getLineWidth',\n    stroke_color: 'getLineColor',\n    fill_color: 'getFillColor'\n  },\n  pointcloud: {\n    opacity: 'opacity',\n    radius_pixels: 'radiusPixels',\n    fill_color: 'getColor',\n    point_color_mode: 'colorMode',\n    point_color_domain: 'colorDomain'\n  },\n  path: {\n    opacity: 'opacity',\n    stroke_width_min_pixels: 'widthMinPixels',\n    stroke_width_max_pixels: 'widthMaxPixels',\n    stroke_color: 'getColor',\n    stroke_width: 'getWidth'\n  },\n  stadium: {\n    opacity: 'opacity',\n    radius_min_pixels: 'widthMinPixels',\n    radius_max_pixels: 'widthMaxPixels',\n    fill_color: 'getColor',\n    radius: 'getWidth'\n  },\n  polygon: {\n    opacity: 'opacity',\n    stroked: 'stroked',\n    filled: 'filled',\n    extruded: 'extruded',\n    stroke_color: 'getLineColor',\n    stroke_width: 'getLineWidth',\n    stroke_width_min_pixels: 'lineWidthMinPixels',\n    stroke_width_max_pixels: 'lineWidthMaxPixels',\n    fill_color: 'getFillColor',\n    height: 'getElevation'\n  },\n  text: {\n    opacity: 'opacity',\n    fill_color: 'getColor',\n    font_family: 'fontFamily',\n    font_weight: 'fontWeight',\n    text_size: 'getSize',\n    text_rotation: 'getAngle',\n    text_anchor: 'getTextAnchor',\n    text_baseline: 'getAlignmentBaseline'\n  }\n};\n\nconst EMPTY_OBJECT = {};\n\n// Access V1 style properties\nconst getInlineProperty = (context, propertyName, objectState) => {\n  const inlineProp = objectState[propertyName];\n  return inlineProp === undefined ? null : inlineProp;\n};\nconst getStylesheetProperty = (context, propertyName, objectState) =>\n  context.style.getProperty(propertyName, objectState);\n\n// Fetch layer property from XVIZ Stylesheet or object\n//\n// Current resolution of property to style attribute has to deal with\n//  - stylesheets taking precedence over inline style attributes\n//  - style attribute names used in the application do not match those of\n//    XVIZ v1\n//\n// TODO(twojtasz): Once XVIZ v1 is removed this logic can be simplified\n// by removing the `altPropertyName` and changing the order of resolution\n// to be inline, stylesheet, then default.\n//\n/* eslint-disable complexity */\nfunction getProperty(context, propertyName, f = EMPTY_OBJECT) {\n  let objectState = f;\n\n  // Handle XVIZ v1 color override where our semantic color mapping\n  // differs from current OCS colors.  In XVIZ v2 we should be aligned.\n  if (context.useSemanticColor) {\n    switch (propertyName) {\n      case 'stroke_color':\n      case 'fill_color':\n        objectState = XVIZObject.get(f.id) || f;\n        break;\n\n      default:\n      // ignore\n    }\n  }\n\n  // Handle XVIZ v1 style property name mismatches and\n  // setup validation function based on property name.\n  let altPropertyName = null;\n\n  switch (propertyName) {\n    case 'stroke_color':\n    case 'fill_color':\n      altPropertyName = 'color';\n      break;\n    case 'stroke_width':\n      altPropertyName = 'thickness';\n      break;\n    case 'radius':\n      // v2 circle inline style\n      if (f.radius) {\n        return f.radius;\n      }\n      break;\n    default:\n      break;\n  }\n\n  // 1a. Property from inline style (v2) or stylesheet\n  let property = getStylesheetProperty(context, propertyName, objectState);\n\n  // 1b. Alt property from inline style (v2) or stylesheet\n  if (property === null && altPropertyName) {\n    property = getStylesheetProperty(context, altPropertyName, objectState);\n  }\n\n  // Backward compatibility\n  if (property === null && !context.disableInlineStyling) {\n    // 2a. Property from inline style (v1)\n    property = getInlineProperty(context, propertyName, objectState);\n\n    // 2b. Alt property from inline style (v1)\n    if (property === null && altPropertyName) {\n      property = getInlineProperty(context, altPropertyName, objectState);\n    }\n  }\n\n  // 3. Property from default style\n  if (property === null) {\n    property = context.style.getPropertyDefault(propertyName);\n  }\n\n  return property;\n}\n/* eslint-enable complexity */\n\nexport default class XVIZLayer extends CompositeLayer {\n  _getProperty(propertyName) {\n    return getProperty(this.props, propertyName);\n  }\n\n  _getPropertyAccessor(propertyName) {\n    return f => getProperty(this.props, propertyName, f);\n  }\n\n  // These props are persistent unless data type and stylesheet change\n  _getDefaultLayerProps(style, styleToLayerProp) {\n    const layerProps = {\n      updateTriggers: {}\n    };\n\n    for (const stylePropName in styleToLayerProp) {\n      const layerPropName = styleToLayerProp[stylePropName];\n      const isAccessor = layerPropName.startsWith('get');\n      if (isAccessor) {\n        layerProps.updateTriggers[layerPropName] = {\n          style: stylePropName,\n          dependencies: style.getPropertyDependencies(stylePropName)\n        };\n      } else {\n        layerProps[layerPropName] = this._getProperty(stylePropName);\n      }\n    }\n\n    return layerProps;\n  }\n\n  _getLayerProps() {\n    const {objectStates} = this.props;\n    const {layerProps} = this.state;\n    const {updateTriggers} = layerProps;\n\n    for (const key in updateTriggers) {\n      const trigger = updateTriggers[key];\n\n      layerProps[key] = this._getPropertyAccessor(trigger.style);\n\n      updateTriggers[key] = {...trigger};\n      trigger.dependencies.forEach(stateName => {\n        updateTriggers[key][stateName] = objectStates[stateName];\n      });\n    }\n\n    return layerProps;\n  }\n\n  _getLayerType(data) {\n    if (data.length > 0) {\n      return data[0].type;\n    }\n    return data.type;\n  }\n\n  updateState({props, oldProps, changeFlags}) {\n    let {type} = this.state;\n\n    if (changeFlags.dataChanged) {\n      // Pre-process data\n      let data = props.data;\n      const dataType = this._getLayerType(data);\n      type = XVIZ_TO_LAYER_TYPE[dataType];\n\n      if (type === 'scatterplot' && data[0].vertices && Array.isArray(data[0].vertices[0])) {\n        // is multi point\n        data = data.reduce((arr, multiPoints) => {\n          multiPoints.vertices.forEach(pt => {\n            arr.push({...multiPoints, vertices: pt});\n          });\n          return arr;\n        }, []);\n      }\n\n      this.setState({data});\n    }\n\n    if (type !== this.state.type || props.style !== oldProps.style) {\n      const styleToLayerProp = STYLE_TO_LAYER_PROP[type];\n      const layerProps = this._getDefaultLayerProps(props.style, styleToLayerProp);\n      this.setState({type, layerProps});\n    }\n  }\n\n  renderLayers() {\n    const {lightSettings} = this.props;\n    const {type, data} = this.state;\n\n    if (!type) {\n      return null;\n    }\n\n    const {linkTitle, streamName, objectType} = this.props;\n    const layerProps = this._getLayerProps();\n    const updateTriggers = layerProps.updateTriggers;\n    const forwardProps = {\n      linkTitle,\n      streamName,\n      objectType\n    };\n\n    switch (type) {\n      case 'scatterplot':\n        return new ScatterplotLayer(\n          forwardProps,\n          layerProps,\n          this.getSubLayerProps({\n            id: 'scatterplot',\n            data,\n            // `vertices` is used xviz V1 and `center` is used by xviz V2\n            getPosition: f => f.vertices || f.center,\n            updateTriggers: deepExtend(updateTriggers, {\n              getFillColor: {useSemanticColor: this.props.useSemanticColor}\n            })\n          })\n        );\n\n      case 'pointcloud':\n        return new PointCloudLayer(\n          forwardProps,\n          layerProps,\n          Array.isArray(data)\n            ? {\n                data: data[0].vertices\n              }\n            : {\n                data: data.ids,\n                numInstances: data.numInstances,\n                instancePositions: data.positions,\n                instanceColors: data.colors\n              },\n          this.getSubLayerProps({\n            id: 'pointcloud',\n            vehicleRelativeTransform: this.props.vehicleRelativeTransform,\n            getPosition: p => p\n          })\n        );\n\n      case 'path':\n        return new PathLayer(\n          forwardProps,\n          layerProps,\n          this.getSubLayerProps({\n            id: 'path',\n            data,\n            getPath: f => f.vertices,\n            updateTriggers: deepExtend(updateTriggers, {\n              getColor: {useSemanticColor: this.props.useSemanticColor}\n            })\n          })\n        );\n\n      case 'stadium':\n        return new PathLayer(\n          forwardProps,\n          layerProps,\n          this.getSubLayerProps({\n            id: 'stadium',\n            data,\n            getPath: f => [f.start, f.end],\n            lineJointRounded: true,\n            updateTriggers: deepExtend(updateTriggers, {\n              getColor: {useSemanticColor: this.props.useSemanticColor}\n            })\n          })\n        );\n\n      case 'polygon':\n        return new PolygonLayer(\n          forwardProps,\n          layerProps,\n          this.getSubLayerProps({\n            id: 'polygon',\n            opacity: this.props.opacity || 1,\n            data,\n            lightSettings,\n            wireframe: layerProps.stroked,\n            getPolygon: f => f.vertices,\n            updateTriggers: deepExtend(updateTriggers, {\n              getLineColor: {useSemanticColor: this.props.useSemanticColor},\n              getFillColor: {useSemanticColor: this.props.useSemanticColor}\n            })\n          })\n        );\n\n      case 'text':\n        return new TextLayer(\n          forwardProps,\n          layerProps,\n          this.getSubLayerProps({\n            id: 'text',\n            data,\n            getText: f => f.text,\n            updateTriggers: deepExtend(updateTriggers, {\n              getColor: {useSemanticColor: this.props.useSemanticColor}\n            })\n          })\n        );\n\n      default:\n        return null;\n    }\n  }\n}\n\nXVIZLayer.layerName = 'XVIZLayer';\n"],"file":"xviz-layer.js"}