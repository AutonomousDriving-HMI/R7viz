{"version":3,"sources":["../../../../src/text-layer/multi-icon-layer/multi-icon-layer.js"],"names":["IconLayer","vs","fs","DEFAULT_GAMMA","DEFAULT_BUFFER","defaultProps","getShiftInQueue","type","value","x","shift","getLengthOfQueue","len","getAnchorX","anchorX","getAnchorY","anchorY","getPixelOffset","getPickingIndex","objectIndex","MultiIconLayer","Object","assign","attributeManager","getAttributeManager","addInstanced","instancePixelOffset","size","transition","accessor","updateParams","changeFlags","updateTriggersChanged","invalidate","uniforms","sdf","props","buffer","gamma","Boolean","attribute","data","iconMapping","getIcon","i","object","icon","rect","shiftX","width","height","pickingColor","point","index","encodePickingColor","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport IconLayer from '../../icon-layer/icon-layer';\n\nimport vs from './multi-icon-layer-vertex.glsl';\nimport fs from './multi-icon-layer-fragment.glsl';\n\n// TODO expose as layer properties\nconst DEFAULT_GAMMA = 0.2;\nconst DEFAULT_BUFFER = 192.0 / 256;\n\nconst defaultProps = {\n  getShiftInQueue: {type: 'accessor', value: x => x.shift || 0},\n  getLengthOfQueue: {type: 'accessor', value: x => x.len || 1},\n  // 1: left, 0: middle, -1: right\n  getAnchorX: {type: 'accessor', value: x => x.anchorX || 0},\n  // 1: top, 0: center, -1: bottom\n  getAnchorY: {type: 'accessor', value: x => x.anchorY || 0},\n  getPixelOffset: {type: 'accessor', value: [0, 0]},\n\n  // object with the same pickingIndex will be picked when any one of them is being picked\n  getPickingIndex: {type: 'accessor', value: x => x.objectIndex}\n};\n\nexport default class MultiIconLayer extends IconLayer {\n  getShaders() {\n    return Object.assign({}, super.getShaders(), {\n      vs,\n      fs\n    });\n  }\n\n  initializeState() {\n    super.initializeState();\n\n    const attributeManager = this.getAttributeManager();\n    attributeManager.addInstanced({\n      instancePixelOffset: {\n        size: 2,\n        transition: true,\n        accessor: 'getPixelOffset'\n      }\n    });\n  }\n\n  updateState(updateParams) {\n    super.updateState(updateParams);\n    const {changeFlags} = updateParams;\n\n    if (\n      changeFlags.updateTriggersChanged &&\n      (changeFlags.updateTriggersChanged.getAnchorX || changeFlags.updateTriggersChanged.getAnchorY)\n    ) {\n      this.getAttributeManager().invalidate('instanceOffsets');\n    }\n  }\n\n  draw({uniforms}) {\n    const {sdf} = this.props;\n    super.draw({\n      uniforms: Object.assign({}, uniforms, {\n        // Refer the following doc about gamma and buffer\n        // https://blog.mapbox.com/drawing-text-with-signed-distance-fields-in-mapbox-gl-b0933af6f817\n        buffer: DEFAULT_BUFFER,\n        gamma: DEFAULT_GAMMA,\n        sdf: Boolean(sdf)\n      })\n    });\n  }\n\n  calculateInstanceOffsets(attribute) {\n    const {\n      data,\n      iconMapping,\n      getIcon,\n      getAnchorX,\n      getAnchorY,\n      getLengthOfQueue,\n      getShiftInQueue\n    } = this.props;\n    const {value} = attribute;\n    let i = 0;\n    for (const object of data) {\n      const icon = getIcon(object);\n      const rect = iconMapping[icon] || {};\n      const len = getLengthOfQueue(object);\n      const shiftX = getShiftInQueue(object);\n\n      value[i++] = ((getAnchorX(object) - 1) * len) / 2 + rect.width / 2 + shiftX || 0;\n      value[i++] = (rect.height / 2) * getAnchorY(object) || 0;\n    }\n  }\n\n  calculateInstancePickingColors(attribute) {\n    const {data, getPickingIndex} = this.props;\n    const {value} = attribute;\n    let i = 0;\n    const pickingColor = [];\n    for (const point of data) {\n      const index = getPickingIndex(point);\n      this.encodePickingColor(index, pickingColor);\n\n      value[i++] = pickingColor[0];\n      value[i++] = pickingColor[1];\n      value[i++] = pickingColor[2];\n    }\n  }\n}\n\nMultiIconLayer.layerName = 'MultiIconLayer';\nMultiIconLayer.defaultProps = defaultProps;\n"],"file":"multi-icon-layer.js"}